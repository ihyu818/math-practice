<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>三角比實驗室 - Math Lab</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="js/session-manager.js?v=20260119"></script>
  <script src="js/scoring-engine.js?v=20260119"></script>
  <script src="js/ui-header.js?v=20260119"></script>
  <script src="js/ui-summary.js?v=20260119"></script>
  <script src="js/sync-protocol.js?v=20260119"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital@1&display=swap" rel="stylesheet">
  <style>
    :root { --fluid-text: clamp(1.5rem, 5vw, 2.5rem); }
    body { background-color: #f8fafc; overflow-x: hidden; touch-action: manipulation; }
    .serif-math { font-family: 'Playfair Display', serif; font-style: italic; }
    .fraction-line { height: 2px; width: 100%; background-color: #1e293b; margin: 4px 0; }
    .input-box { transition: all 0.2s; min-width: 60px; height: 40px; }
    .input-active { background-color: #f0fdf4; border-bottom: 3px solid #16a34a !important; }
    .key-btn { height: 50px; display: flex; items-center; justify-center; border-radius: 8px; font-weight: bold; font-size: 1.2rem; cursor: pointer; user-select: none; }
    .key-btn:active { transform: scale(0.95); opacity: 0.8; }
  </style>
</head>
<body class="text-slate-800 font-sans">
  <div id="app"></div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz5SPY0XNjPWaRAgSmSZx1cSgTTeuACaT17Lx96Oy0TkALO0mgOKA-mr3KuUtFCNVir2Q/exec';
    const pythagoreanTriples = [[3, 4, 5], [5, 12, 13], [7, 24, 25], [8, 15, 17], [9, 40, 41]];

    let state = {
      mode: 'play',
      sessionId: SessionManager.getSessionId(),
      name: SessionManager.getName(),
      gameType: 'trigRatio',
      problem: null,
      num: "", den: "", activeField: 'num', // num: 分子, den: 分母
      score: 0, combo: 0, maxCombo: 0, timeLeft: 120,
      totalSolved: 0, startTime: 0, isCorrectFlash: false
    };

    function nextProblem() {
      const base = pythagoreanTriples[Math.floor(Math.random() * pythagoreanTriples.length)];
      let [x, y, r] = Math.random() > 0.5 ? [base[0], base[1], base[2]] : [base[1], base[0], base[2]];
      const scale = Math.random() > 0.8 ? 2 : 1;
      x *= scale; y *= scale; r *= scale;

      const quad = Math.floor(Math.random() * 4) + 1;
      if (quad === 2) x = -x;
      else if (quad === 3) { x = -x; y = -y; }
      else if (quad === 4) y = -y;

      const types = ['sin', 'cos', 'tan'];
      const type = types[Math.floor(Math.random() * types.length)];

      state.problem = { x, y, r, type };
      state.num = ""; state.den = ""; state.activeField = 'num';
      state.startTime = Date.now();
      render();
    }

    function render() {
      const app = document.getElementById('app');
      if (!app) return;
      if (state.mode === 'end') { app.innerHTML = ""; UISummary.render('app', state); return; }

      app.innerHTML = `
        <div class="min-h-screen p-4 flex flex-col items-center max-w-xl mx-auto ${state.isCorrectFlash ? 'bg-green-50' : ''}">
          <div id="header-area" class="w-full"></div>
          
          <div class="mt-6 text-center">
            <div class="text-lg text-slate-500 font-bold serif-math">
              P( <span class="text-slate-800">${state.problem.x}, ${state.problem.y}</span> ) 為終邊上一點
            </div>
            <div class="text-3xl font-black my-4 serif-math text-green-700">${state.problem.type} θ = ?</div>
          </div>

          <canvas id="trigCanvas" width="320" height="320" class="bg-white rounded-xl shadow-inner mb-6"></canvas>

          <div class="flex items-center space-x-4 mb-8">
            <span class="text-3xl serif-math">${state.problem.type} θ =</span>
            <div class="flex flex-col items-center w-24">
              <div class="input-box w-full text-center text-2xl font-bold flex items-center justify-center border-b-2 border-slate-200 ${state.activeField === 'num' ? 'input-active' : ''}" onclick="state.activeField='num';render();">${state.num}</div>
              <div class="fraction-line"></div>
              <div class="input-box w-full text-center text-2xl font-bold flex items-center justify-center ${state.activeField === 'den' ? 'input-active' : ''}" onclick="state.activeField='den';render();">${state.den}</div>
            </div>
          </div>

          <div class="grid grid-cols-4 gap-2 w-full max-w-md">
            ${[7,8,9,'DEL',4,5,6,'/',1,2,3,'←',0,'-','→','Enter'].map(k => `
              <div class="key-btn ${typeof k === 'number' ? 'bg-white shadow' : (k==='Enter'?'bg-green-600 text-white':'bg-slate-200')}" onclick="handleKey('${k}')">${k}</div>
            `).join('')}
          </div>
        </div>`;
      
      UIHeader.render('header-area', state);
      drawDiagram();
    }

    function drawDiagram() {
      const canvas = document.getElementById('trigCanvas');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const cx = 160, cy = 160, r_visual = 130;
      const { x, y, r } = state.problem;
      const px = cx + (x / r) * r_visual;
      const py = cy - (y / r) * r_visual;

      ctx.clearRect(0, 0, 320, 320);
      
      // 坐標軸
      ctx.strokeStyle = '#e2e8f0'; ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(cx, 0); ctx.lineTo(cx, 320); ctx.moveTo(0, cy); ctx.lineTo(320, cy); ctx.stroke();

      // 圓周
      ctx.setLineDash([]); ctx.strokeStyle = '#f1f5f9';
      ctx.beginPath(); ctx.arc(cx, cy, r_visual, 0, Math.PI * 2); ctx.stroke();

      // 參考三角形 (垂線)
      ctx.setLineDash([5, 5]); ctx.strokeStyle = '#cbd5e1';
      ctx.beginPath(); ctx.moveTo(px, py); ctx.lineTo(px, cy); ctx.stroke();

      // 弧形箭頭 (theta)
      const angle = Math.atan2(y, x);
      const endRad = angle < 0 ? -angle : Math.PI * 2 - angle;
      ctx.setLineDash([]); ctx.strokeStyle = '#3b82f6'; ctx.lineWidth = 2;
      ctx.beginPath(); ctx.arc(cx, cy, 30, 0, -angle, angle < 0); ctx.stroke();

      // 終邊
      ctx.strokeStyle = '#16a34a'; ctx.lineWidth = 4; ctx.lineCap = 'round';
      ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(px, py); ctx.stroke();

      // P點
      ctx.fillStyle = '#15803d'; ctx.beginPath(); ctx.arc(px, py, 5, 0, Math.PI * 2); ctx.fill();
    }

    function handleKey(k) {
      if (k === 'DEL') {
        if (state[state.activeField] === "" && state.activeField === 'den') state.activeField = 'num';
        else state[state.activeField] = state[state.activeField].slice(0, -1);
      } else if (k === '/' || k === '→') {
        state.activeField = 'den';
      } else if (k === '←') {
        state.activeField = 'num';
      } else if (k === '-') {
        if (!state[state.activeField].includes('-')) state[state.activeField] = '-' + state[state.activeField];
      } else if (k === 'Enter') {
        checkAnswer();
      } else if (!isNaN(k)) {
        state[state.activeField] += k;
      }
      render();
    }

    function checkAnswer() {
      if (!state.num || !state.den) return;
      const userVal = parseFloat(state.num) / parseFloat(state.den);
      const isCorrect = Math.abs(userVal - state.problem.target) < 0.001;

      if (isCorrect) {
        state.isCorrectFlash = true;
        const ts = (Date.now() - state.startTime) / 1000;
        ScoringEngine.processCorrect(state, ts);
        SyncProtocol.saveLog(SCRIPT_URL, state, { problem: state.problem.type, userAns: `${state.num}/${state.den}` });
        setTimeout(() => { state.isCorrectFlash = false; nextProblem(); }, 400);
      } else {
        state.combo = 0; render();
      }
    }

    function startTimer() {
      const t = setInterval(() => {
        state.timeLeft--;
        if (state.timeLeft <= 0) { clearInterval(t); state.mode = 'end'; SyncProtocol.saveSummary(SCRIPT_URL, state); }
        render();
      }, 1000);
    }

    UIHeader.initTheme(); nextProblem(); startTimer();
  </script>
</body>
</html>
