<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>配方法實驗室 - Math Lab</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --fluid-text: clamp(1.2rem, 6vw, 2.5rem); --fluid-slot: clamp(1.5rem, 8vw, 3.5rem); }
    body { background-color: #f8fafc; touch-action: manipulation; }
    .key-btn { 
      display: flex; align-items: center; justify-content: center; 
      background-color: white; border: 1px solid #e5e7eb; border-radius: 0.75rem; 
      font-weight: bold; font-size: 1.2rem; height: 50px; cursor: pointer; 
      user-select: none; -webkit-tap-highlight-color: transparent; touch-action: manipulation;
    }
    .key-btn:active { background-color: #eff6ff; transform: scale(0.95); }
    .key-btn-op { background-color: #eff6ff; color: #2563eb; border-color: #bfdbfe; }
    .key-btn-next { background-color: #3b82f6; color: white; border-color: #2563eb; }
    .slot { 
      border-bottom: 3px solid #d1d5db; min-width: var(--fluid-slot); 
      height: 45px; display: inline-flex; align-items: center; justify-content: center; 
      font-weight: 800; font-size: var(--fluid-text); transition: all 0.2s; 
    }
    .slot.active { border-color: #3b82f6; background-color: #eff6ff; }
    .correct-flash { animation: flash 0.3s ease-out; }
    @keyframes flash { 0% { background-color: transparent; } 50% { background-color: #d1fae5; } 100% { background-color: transparent; } }
    #timer-bar { transition: width 1s linear; }
  </style>
</head>
<body class="text-slate-800 font-sans">
  <div id="app"></div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz5SPY0XNjPWaRAgSmSZx1cSgTTeuACaT17Lx96Oy0TkALO0mgOKA-mr3KuUtFCNVir2Q/exec'; 
    const TOTAL_TIME = 120;

    function generateSessionId() {
      return Math.random().toString(36).substring(2, 12).toUpperCase() + 
             Math.random().toString(36).substring(2, 12).toUpperCase();
    }
    
    let state = {
      mode: 'play',
      name: localStorage.getItem('math_lab_name') || 'Guest',
      sessionId: generateSessionId(), // 每一場遊戲都有唯一的 ID
      problem: null, 
      userInputs: ["", "", "", ""],
      currentSlot: 0,
      isAnswerCorrect: false, score: 0, combo: 0, maxCombo: 0, timeLeft: TOTAL_TIME,
      hasUsedBack: false
    };

    let timer = null;

    // --- 模組 1: MathKeyboard (輸入管理) ---
    const MathKeyboard = (callback) => {
      window.onkeydown = (e) => {
        if (state.mode !== 'play' || state.isAnswerCorrect) return;
        if ((e.key >= '0' && e.key <= '9') || e.key === '+' || e.key === '-') {
          callback(e.key);
        } else if (e.key === 'Backspace') {
          e.preventDefault();
          callback('back');
        } else if (e.key === 'Enter' || e.key === ' ' || e.key === 'ArrowRight' || e.key === 'Tab') {
          e.preventDefault();
          callback('next');
        } else if (e.key === 'ArrowLeft') {
          e.preventDefault();
          if (state.currentSlot > 0) { state.currentSlot--; render(); }
        }
      };
    };

    // --- 模組 2: ScoreSystem (計分與 API 管理) ---
    const ScoreSystem = {
      calculateEarn: (combo, hasUsedBack) => {
        if (hasUsedBack) return 1.0;
        const k = combo;
        const bonusA = k > 0 ? 0.1 * (k - 1) : 0;
        const bonusB = (k > 0 && k % 3 === 0) ? (0.01 * Math.pow(2, (k / 3) - 1)) : 0;
        return 1 + bonusA + bonusB;
      },
      handleCorrect: (state, ts, problemInfo) => {
        if (state.hasUsedBack) state.combo = 0;
        else {
          state.combo++;
          if (state.combo > state.maxCombo) state.maxCombo = state.combo;
        }
        const earn = ScoreSystem.calculateEarn(state.combo, state.hasUsedBack);
        state.score += earn;

        // 統一傳送格式：包含 sessionId 與 type
        fetch(`${SCRIPT_URL}?action=save&type=Square&sessionId=${state.sessionId}&studentName=${encodeURIComponent(state.name)}&problem=${encodeURIComponent(problemInfo.display)}&correctAnswer=${encodeURIComponent(problemInfo.ans)}&userAnswer=${encodeURIComponent(problemInfo.userAns)}&isCorrect=true&timeSpent=${ts.toFixed(2)}&score=${earn.toFixed(4)}&combo=${state.combo}`, { mode: 'no-cors' });
        
        return earn;
      }
    };

    function render() {
      const app = document.getElementById('app');
      if (state.mode === 'play' && !state.problem) return;

      if (state.mode === 'play') {
        const timePercent = (state.timeLeft / TOTAL_TIME) * 100;
        app.innerHTML = `
          <div class="min-h-screen p-3 flex flex-col items-center max-w-4xl mx-auto ${state.isAnswerCorrect ? 'correct-flash' : ''}">
            <div class="w-full bg-gray-200 h-2 rounded-full mb-3 overflow-hidden">
              <div id="timer-bar" class="bg-blue-500 h-full" style="width: ${timePercent}%"></div>
            </div>
            <div class="w-full grid grid-cols-3 bg-white p-3 rounded-2xl shadow-sm mb-4 items-center text-center">
              <div class="text-left truncate text-[10px] text-slate-300 font-bold uppercase tracking-tighter">${state.name}</div>
              <div><div class="text-[8px] text-slate-400 uppercase">Score</div><div class="text-xl text-blue-600 font-black">${state.score.toFixed(1)}</div></div>
              <div class="text-right"><div class="text-[8px] text-slate-400 uppercase">Combo</div><div class="text-xl font-black text-orange-500">${state.combo}</div></div>
            </div>
            <div class="text-center mb-6 h-20 flex flex-col justify-center">
              <div class="text-sm text-slate-400 font-bold mb-1 uppercase tracking-widest italic">Complete the Square</div>
              <div class="font-black text-slate-800" style="font-size: var(--fluid-text)">${state.problem.display}</div>
            </div>
            <div class="mb-10 font-black flex items-center justify-center gap-1 text-slate-700 w-full" style="font-size: clamp(1rem, 5vw, 2rem)">
              <span class="text-slate-800">= ( x </span>
              <div class="slot ${state.currentSlot===0?'active':''} text-blue-600">${state.userInputs[0]}</div>
              <div class="slot ${state.currentSlot===1?'active':''} text-blue-600">${state.userInputs[1]}</div>
              <span> )² </span>
              <div class="slot ${state.currentSlot===2?'active':''} text-blue-600">${state.userInputs[2]}</div>
              <div class="slot ${state.currentSlot===3?'active':''} text-blue-600">${state.userInputs[3]}</div>
            </div>
            <div class="w-full max-w-sm grid grid-cols-4 gap-2">
              <div class="col-span-3 grid grid-cols-3 gap-2">
                ${[7,8,9,4,5,6,1,2,3,0].map(n => `<div onclick="pressKey('${n}')" class="key-btn shadow-sm">${n}</div>`).join('')}
                <div onclick="pressKey('+')" class="key-btn key-btn-op shadow-sm">+</div>
                <div onclick="pressKey('-')" class="key-btn key-btn-op shadow-sm">-</div>
              </div>
              <div class="col-span-1 flex flex-col gap-2">
                <div onclick="pressKey('back')" class="key-btn bg-red-50 text-red-500 shadow-sm flex-grow text-xl">⌫</div>
                <div onclick="pressKey('next')" class="key-btn key-btn-next shadow-lg h-24 text-lg italic font-black uppercase">Next</div>
              </div>
            </div>
          </div>`;
      } else if (state.mode === 'end') {
        app.innerHTML = `<div class="min-h-screen flex items-center justify-center p-4"><div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm text-center border-b-8 border-blue-600">
          <h2 class="text-2xl font-black mb-4 text-slate-800 italic uppercase">Mission Success</h2>
          <div class="text-6xl font-black text-blue-600 mb-8">${state.score.toFixed(2)}</div>
          <button onclick="location.reload()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black shadow-lg mb-4">Retry</button>
          <button onclick="location.href='index.html'" class="w-full text-slate-400 font-bold uppercase tracking-widest text-sm">Main Menu</button>
        </div></div>`;
      }
    }

    function generateProblem() {
      let k, t;
      do { k = Math.floor(Math.random() * 19) - 9; } while (k === 0);
      do { t = Math.floor(Math.random() * 19) - 9; } while (t === 0);
      const b = 2 * k;
      const bText = b > 0 ? `+ ${b}x` : `- ${Math.abs(b)}x`;
      const tText = t > 0 ? `+ ${t}` : `- ${Math.abs(t)}`;
      return { display: `x² ${bText} ${tText}`, ansK: k, ansM: t - k*k, start: Date.now() };
    }

    function pressKey(key) {
      if (state.isAnswerCorrect) return;
      if (key === 'back') {
        state.hasUsedBack = true;
        if (state.userInputs[state.currentSlot] === "" && state.currentSlot > 0) state.currentSlot--;
        state.userInputs[state.currentSlot] = state.userInputs[state.currentSlot].slice(0, -1);
      } 
      else if (key === 'next') {
        if (state.userInputs[state.currentSlot] === "") {
          const target = (state.currentSlot <= 1) ? state.problem.ansK : state.problem.ansM;
          if (target === 0) state.userInputs[state.currentSlot] = (state.currentSlot % 2 === 0) ? "+" : "0";
          else return;
        }
        if (state.currentSlot < 3) state.currentSlot++;
        else checkAnswer();
      } 
      else {
        if (state.currentSlot % 2 === 0) {
          if (key === '+' || key === '-') { state.userInputs[state.currentSlot] = key; state.currentSlot++; }
        } else {
          if (!isNaN(key)) {
            state.userInputs[state.currentSlot] += key;
            checkAnswer();
            if (!state.isAnswerCorrect && state.currentSlot === 1 && state.userInputs[1].length >= 1) state.currentSlot = 2;
          }
        }
      }
      render();
    }

    function checkAnswer() {
      if (state.userInputs.some(i => i === "")) return;
      const vK = parseInt((state.userInputs[0]||"+") + (state.userInputs[1]||"0"));
      const vM = parseInt((state.userInputs[2]||"+") + (state.userInputs[3]||"0"));
      if (vK === state.problem.ansK && vM === state.problem.ansM) {
        const ts = (Date.now() - state.problem.start) / 1000;
        ScoreSystem.handleCorrect(state, ts, {
          type: 'Square', display: state.problem.display,
          ans: `${state.problem.ansK},${state.problem.ansM}`, userAns: `${vK},${vM}`
        });
        state.isAnswerCorrect = true;
        render();
        setTimeout(() => {
          state.problem = generateProblem();
          state.userInputs = ["", "", "", ""];
          state.currentSlot = 0;
          state.isAnswerCorrect = false;
          state.hasUsedBack = false;
          render();
        }, 400);
      }
    }

    function handleStart() {
      state.problem = generateProblem();
      timer = setInterval(() => {
        state.timeLeft--;
        if (state.timeLeft <= 0) { 
          endGame(); // 呼叫獨立出來的結束函數
        } else {
          render();
        }
      }, 1000);
      render();
      MathKeyboard(pressKey);
    }

    function endGame() {
      if (timer) clearInterval(timer);
      state.mode = 'end';
      render();

      // 計算統計數據
      const accuracy = state.totalProblems > 0 ? ((state.perfectCorrect / state.totalProblems) * 100).toFixed(1) : "0.0";
      
      // 發送總結資料到 Google Sheets
      fetch(`${SCRIPT_URL}?action=saveSummary&type=Square&sessionId=${state.sessionId}&studentName=${encodeURIComponent(state.name)}&score=${state.score.toFixed(2)}&maxCombo=${state.maxCombo}`, { mode: 'no-cors' });
    }
    
    window.onload = handleStart;
  </script>
</body>
</html>
