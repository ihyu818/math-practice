<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Âõ†ÂºèÂàÜËß£ÂØ¶È©óÂÆ§</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .key-btn { display: flex; align-items: center; justify-content: center; background-color: white; border: 1px solid #e5e7eb; border-radius: 0.75rem; font-size: 1.5rem; font-weight: bold; height: 55px; transition: all 0.05s; cursor: pointer; user-select: none; -webkit-tap-highlight-color: transparent; }
    .key-btn:active { background-color: #fdf2f8; transform: scale(0.92); }
    .key-btn-op { background-color: #fdf2f8; color: #db2777; border-color: #fbcfe8; }
    .key-btn-next { background-color: #10b981; color: white; border-color: #059669; }
    .slot { border-bottom: 3px solid #d1d5db; min-width: 45px; text-align: center; height: 50px; display: inline-flex; align-items: center; justify-content: center; font-weight: 800; transition: all 0.2s; pointer-events: none; }
    .slot.active { border-color: #db2777; background-color: #fff1f2; }
    .correct-flash { animation: flash 0.3s ease-out; }
    @keyframes flash { 0% { background-color: transparent; } 50% { background-color: #d1fae5; } 100% { background-color: transparent; } }
    #timer-bar { transition: width 1s linear; }
  </style>
</head>
<body class="bg-gray-50 overflow-x-hidden text-slate-800 font-sans">
  <div id="app"></div>

  <script>
    const LEADERBOARD_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSsRbSkdS47TMRDMHkp9RDNevrhcapO29YCcn0e4ey4la1RxhEIyYfGcvFElqladVxKsNcoLJi2RHSk/pubhtml?gid=1870741910&single=true&range=G1:H11'; 
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz5SPY0XNjPWaRAgSmSZx1cSgTTeuACaT17Lx96Oy0TkALO0mgOKA-mr3KuUtFCNVir2Q/exec'; 
    const TOTAL_TIME = 120;

    let state = {
      mode: 'login', name: '', problem: null, 
      userInputs: ["", "", "", ""], currentSlot: 0, 
      isAnswerCorrect: false, score: 0, combo: 0, maxCombo: 0, timeLeft: TOTAL_TIME,
      hasUsedBack: false
    };

    let timer = null;

    function render() {
      const app = document.getElementById('app');
      if (state.mode === 'login') {
        app.innerHTML = `
          <div class="min-h-screen flex flex-col items-center justify-start p-4 pt-12 text-center">
            <div class="bg-white p-8 rounded-3xl shadow-xl max-w-md w-full border-t-8 border-pink-600 mb-8">
              <h1 class="text-3xl font-black mb-4 italic uppercase text-pink-900 leading-none tracking-tight">Factorization<br>Laboratory</h1>
              <input type="text" id="nameInput" maxlength="12" class="w-full px-4 py-4 border-2 rounded-2xl mb-4 outline-none focus:border-pink-500 text-center font-bold text-xl shadow-inner" placeholder="ÊÇ®ÁöÑÂßìÂêç" value="${state.name}">
              <button onclick="handleStart(event)" class="w-full bg-pink-600 text-white py-4 rounded-2xl font-black hover:bg-pink-700 shadow-lg active:scale-95 transition-all uppercase tracking-widest text-lg">ENTER LAB</button>
            </div>
            <div class="w-full max-w-md bg-white rounded-2xl shadow-md overflow-hidden border border-gray-100 text-left">
              <div class="bg-amber-500 text-white py-2 px-4 font-black italic flex items-center justify-between text-sm">
                <span>üèÜ RANKING</span>
                <button onclick="render()" class="text-[10px] bg-white text-amber-600 px-2 py-1 rounded-md shadow uppercase font-bold">Refresh</button>
              </div>
              <iframe src="${LEADERBOARD_URL}&cachebust=${Date.now()}" class="w-full h-64 border-none"></iframe>
            </div>
          </div>`;
        const ni = document.getElementById('nameInput');
        ni.oninput = (e) => { state.name = e.target.value; };
        ni.onkeydown = (e) => { if(e.key === 'Enter') handleStart(e); };
        ni.focus();
      } 
      else if (state.mode === 'play') {
        const timePercent = (state.timeLeft / TOTAL_TIME) * 100;
        app.innerHTML = `
          <div class="min-h-screen p-4 flex flex-col items-center ${state.isAnswerCorrect ? 'correct-flash' : ''}">
            <div class="w-full max-w-xl bg-gray-200 h-2 rounded-full mb-4 overflow-hidden shadow-inner">
              <div id="timer-bar" class="bg-pink-500 h-full" style="width: ${timePercent}%"></div>
            </div>

            <div class="w-full max-w-xl grid grid-cols-3 bg-white p-4 rounded-2xl shadow-md mb-8 text-center items-center font-bold text-gray-400">
              <div class="text-left truncate text-xs italic font-bold text-slate-300 uppercase">${state.name}</div>
              <div><div class="text-[10px] uppercase tracking-wider">Score</div><div class="text-2xl text-pink-600 font-black">${state.score.toFixed(2)}</div></div>
              <div class="text-right"><div class="text-[10px] uppercase tracking-wider">Combo</div><div class="text-2xl font-black ${state.combo > 0 ? 'text-orange-500' : ''}">${state.combo}</div></div>
            </div>

            <div class="text-center mb-6 h-16 flex items-center justify-center">
              <div class="text-3xl font-black text-slate-800 tracking-tighter">${state.problem.display}</div>
            </div>

            <div class="mb-10 text-3xl font-black flex items-center gap-1 text-slate-700">
              <span class="mr-2 text-slate-400">=</span>
              <span>( x </span>
              <div class="slot ${state.currentSlot===0?'active':''} w-12 text-pink-600">${state.userInputs[0]}</div>
              <div class="slot ${state.currentSlot===1?'active':''} w-16 text-pink-600">${state.userInputs[1]}</div>
              <span> ) ( x </span>
              <div class="slot ${state.currentSlot===2?'active':''} w-12 text-pink-600">${state.userInputs[2]}</div>
              <div class="slot ${state.currentSlot===3?'active':''} w-16 text-pink-600">${state.userInputs[3]}</div>
              <span> )</span>
            </div>

            <div class="flex flex-col gap-2 w-full max-w-[360px]">
              <div class="grid grid-cols-4 gap-2">
                <div class="col-span-3 grid grid-cols-3 gap-2">
                  ${[7,8,9,4,5,6,1,2,3].map(n => `<div onclick="pressKey('${n}')" class="key-btn shadow-sm">${n}</div>`).join('')}
                  <div onclick="pressKey('0')" class="key-btn shadow-sm">0</div>
                  <div onclick="pressKey('+')" class="key-btn key-btn-op shadow-sm">+</div>
                  <div onclick="pressKey('-')" class="key-btn key-btn-op shadow-sm">-</div>
                </div>
                <div class="col-span-1 flex flex-col gap-2">
                  <div onclick="pressKey('back')" class="key-btn bg-red-50 text-red-500 shadow-sm flex-1 text-xl">‚å´</div>
                </div>
              </div>
              <div onclick="pressKey('next')" class="key-btn key-btn-next shadow-lg text-lg italic uppercase font-black tracking-widest w-full">Next / Enter / ‚Üí</div>
            </div>
          </div>`;
      }
      else if (state.mode === 'end') {
        app.innerHTML = `<div class="min-h-screen flex items-center justify-center p-4">
          <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm border-b-8 border-pink-600 text-center">
            <div class="text-gray-400 font-bold mb-1 uppercase tracking-widest text-xs">${state.name}</div>
            <h2 class="text-3xl font-black mb-6 italic text-slate-800 uppercase tracking-tighter">Mission Success</h2>
            <div class="text-6xl font-black text-pink-600 mb-8">${state.score.toFixed(2)}</div>
            <div id="end-actions" class="opacity-30 pointer-events-none transition-all duration-700 flex flex-col gap-3">
              <button onclick="location.reload()" class="w-full bg-pink-600 text-white py-4 rounded-2xl font-black shadow-lg uppercase tracking-widest">Retry</button>
              <button onclick="location.href='index.html'" class="w-full bg-gray-100 text-gray-400 py-3 rounded-2xl font-bold uppercase tracking-widest text-sm text-slate-400">Back to Menu</button>
            </div>
          </div>
        </div>`;
        setTimeout(() => { document.getElementById('end-actions').classList.remove('opacity-30','pointer-events-none'); }, 1500);
      }
    }

    function handleStart(e) {
      if(e) { e.preventDefault(); e.stopPropagation(); }
      const safePattern = /^[a-zA-Z0-9\u4e00-\u9fa5\s]+$/;
      if (state.name.trim() && safePattern.test(state.name)) {
        state.mode = 'play';
        state.currentSlot = 0; 
        nextProblem();
        if (timer) clearInterval(timer);
        timer = setInterval(() => { 
            state.timeLeft--; 
            if (state.timeLeft <= 0) endGame(); 
            else {
                const bar = document.getElementById('timer-bar');
                if(bar) bar.style.width = (state.timeLeft / TOTAL_TIME * 100) + '%';
            }
        }, 1000);
      } else { alert('Ë´ãËº∏ÂÖ•ÊúâÊïàÂßìÂêç'); }
    }

    function nextProblem() {
      const a = Math.floor(Math.random() * 19) - 9;
      const b = Math.floor(Math.random() * 19) - 9;
      const B = a + b, C = a * b;
      let bT = B===0?"":(B===1?"+ x":(B===-1?"- x":(B>0?"+ "+B+"x":"- "+Math.abs(B) + "x")));
      let cT = C===0?"":(C>0?"+ "+C:"- "+Math.abs(C));
      state.problem = { display: `x¬≤ ${bT} ${cT}`, ansA: a, ansB: b, start: Date.now() };
      state.userInputs = ["", "", "", ""]; 
      state.currentSlot = 0; 
      state.isAnswerCorrect = false;
      state.hasUsedBack = false;
      render();
    }

    function pressKey(key) {
      if (state.isAnswerCorrect) return;
      if (key === 'back') {
        state.hasUsedBack = true;
        if (state.userInputs[state.currentSlot] === "" && state.currentSlot > 0) state.currentSlot--;
        state.userInputs[state.currentSlot] = "";
      } 
      else if (key === 'next') {
        if (state.currentSlot < 3) state.currentSlot++;
        checkAnswer(true); 
      } 
      else {
        if (state.currentSlot % 2 === 0) {
          if (key === '+' || key === '-') {
            if (state.userInputs[state.currentSlot] !== "" && state.userInputs[state.currentSlot] !== key) state.hasUsedBack = true;
            state.userInputs[state.currentSlot] = key;
            state.currentSlot++;
          }
        } else {
          if (!isNaN(key)) {
            if (state.userInputs[state.currentSlot] !== "" && state.userInputs[state.currentSlot] !== key) state.hasUsedBack = true;
            state.userInputs[state.currentSlot] = key;
            if (state.currentSlot === 3) { render(); checkAnswer(true); return; } else { state.currentSlot++; }
          }
        }
      }
      render();
    }

    function checkAnswer(force) {
      const v1 = parseInt((state.userInputs[0] || "+") + (state.userInputs[1] || "0"));
      const v2 = parseInt((state.userInputs[2] || "+") + (state.userInputs[3] || "0"));
      const t1 = state.problem.ansA, t2 = state.problem.ansB;
      const isCorrect = (v1 === t1 && v2 === t2) || (v1 === t2 && v2 === t1);
      if (isCorrect && force) handleCorrect(v1, v2);
    }

    function handleCorrect(v1, v2) {
      state.isAnswerCorrect = true;
      const ts = (Date.now() - state.problem.start) / 1000;
      if (state.hasUsedBack) state.combo = 0; else state.combo++;
      if (state.combo > state.maxCombo) state.maxCombo = state.combo;
      let earn = state.combo > 0 ? (1 + (0.1 * (state.combo - 1))) : 1;
      if (state.combo > 0 && state.combo % 3 === 0) {
        const k = state.combo / 3;
        earn += 0.01 * Math.pow(2, k - 1);
      }
      state.score += earn;
      render();
      fetch(`${SCRIPT_URL}?action=save&type=Factor&studentName=${encodeURIComponent(state.name)}&problem=${encodeURIComponent(state.problem.display)}&correctAnswer=${state.problem.ansA},${state.problem.ansB}&userAnswer=${v1},${v2}&isCorrect=true&timeSpent=${ts}&score=${earn.toFixed(4)}&combo=${state.combo}`, { mode: 'no-cors' });
      setTimeout(nextProblem, 300);
    }

    function endGame() { 
      clearInterval(timer); state.mode = 'end'; render();
      fetch(`${SCRIPT_URL}?action=saveSummary&type=Factor&studentName=${encodeURIComponent(state.name)}&score=${state.score.toFixed(2)}&maxCombo=${state.maxCombo}`, { mode: 'no-cors' });
    }

    window.onkeydown = (e) => {
      if (state.mode === 'play') {
        if (e.key >= '0' && e.key <= '9') pressKey(e.key);
        else if (e.key === '+' || e.key === '-') pressKey(e.key);
        else if (e.key === 'Backspace' || e.key === 'ArrowLeft') { e.preventDefault(); pressKey('back'); }
        else if (e.key === 'Enter' || e.key === ' ' || e.key === 'ArrowRight') { e.preventDefault(); pressKey('next'); }
      }
    };
    render();
  </script>
</body>
</html>
